{% extends 'base_test/base.html' %}
{% block content %}

{% load staticfiles %}


<style>
.login_content{ margin-top : 10px; }

.custom_form_group{
    width: 100%;
    margin-top: 16px;
}

.custom_row{
    margin-bottom: 18px;
}

.image_dir{
	width: 100px;
    height: 100px;
}
.img_class_dev{
    display: block;
    float: left;
    margin-right: 15px;
    background : grey;
}
.img_block_dev{
    height: 113px;
}

</style>
<script>

var google_data = {};

    $(document).ready(function(){
        var friends_list = {{ member_list|safe }};
        console.log(friends_list);
        $("#member_ist_templ").tmpl(friends_list).appendTo( "#friends_list" );

		$(friends_list).each(function(index, item){
			if(item.tag_names){
				$(item.tag_names.split(', ')).each(function(index_sub, item_sub){
						$('#member_tags_'+item.id).append($('<button/>').addClass('btn btn-theme').text(item_sub));
				});
			}
		});

			    google_data = {"type" : "FeatureCollection"
				                   , "features" : [] };

				var _features = [];

				$(friends_list).each(function(index, item){
						var _feature = {};
						var _geometry = {};
						var _temp = [];
						_temp.push(parseFloat(item.google_location.split(',')[0]));
						_temp.push(parseFloat(item.google_location.split(',')[1]));

						_geometry['coordinates'] = _temp;
						_geometry['type'] = 'Point';
						_geometry['id'] = index.id;

						_feature['type'] = "Feature";
						_feature['geometry'] = _geometry;
					_features.push(_feature);
				});

				google_data['features'] = _features;

		//{"type":"Feature","geometry":{"type":"Point","coordinates":[37.517932,127.021830]},"id":"ak10559055"},


		$('.member_detail_btn').click(function(){
			_followee_id = $(this).attr('id');
			_tag_list = $(this).attr('tags');

			getAjax('GET', "/member/member_detail/"+_followee_id
			, 'application/json', function(response){

				$('#member_detail_photo').empty();
				$(response).each(function(index, item){
					$('#member_detail_photo').append($('<img/>').height(200).attr('src',item.img_file))
				});

				$('#member_like_btn').attr('followee_id', _followee_id);
				$('#member_detail_hashtag').val('').val(_tag_list);
				$('#myBtn').trigger('click');
			});
		});


	 $('#member_like_btn').click(function(){
		postAjax('POST', {}, '/member/member_detail/'+$(this).attr('followee_id')+'/'
			, 'application/json', function(response){
				alert('좋아요 반영되었고요 좋았던 사람 또 좋아요 누를면 지금은 에러나요');
		});
	 });



		openModal();
    });

</script>


<script id="member_ist_templ" type="text/x-jquery-tmpl">
            <div class="img_block_dev">
            	<span class="img_class_dev member_detail_btn" id= '${id}' tags='${tag_names}'> <img class="image_dir" src="${img_file}" alt=""></span>
                <span>
                	<strong class="member_detail_btn" id= '${id}' tags= '${ tag_names }'>${username}</strong>
                </span>
                <br>
				<span id="member_tags_${id}"></span>
				<br>
				<button class="btn btn-danger"> 좋아요 횟수 : ${ likes } </button>
            </div>
</script>

<!-- *****************************************************************************************************************
	 BLUE WRAP
	 ***************************************************************************************************************** -->
	<div id="blue">
	    <div class="container">
			<div class="row">
				<h3>사용자 목록 조회</h3>
			</div><!-- /row -->
	    </div> <!-- /container -->
	</div><!-- /blue -->


	<!-- *****************************************************************************************************************
	 CONTACT FORMS
	 ***************************************************************************************************************** -->

	 <div class="container mtb login_content">
	 	<div class="row custom_row">
            <div class="col-lg-12">
	 			<h4>친구들의 위치와 목록을 조회하는 페이지입니다.</h4>
                <div class="hline"></div>
                <div class="form-inline">
                    <div class="form-group custom_form_group">
                <input type="search" class="form-control"/>
                <button class="btn btn-warning">Search</button>
                    </div>
                </div>
			</div>
         </div>
         <div class="row">
            <div class="col-lg-6">
                    <div id="map" style="width:100%;height:500px"></div>
			</div>
            <div class="col-lg-6" id="friends_list">
			</div>
	 	</div><! --/row -->
	 </div><! --/container -->


    <script>
   var markers = [];
	var map;
	var geocoder;
	var infowindow = null;

	var latitude = 0;
	var longitude = 0;

	function myMap() {
		geocoder = new google.maps.Geocoder();

		// GPS 인식 가능 여부(현재 위치)
		if (navigator.geolocation) {

			navigator.geolocation.watchPosition(function (pos) {

				// 현재 위경도 값(GPS) 변수에 넣기.
				var latitude = pos.coords.latitude;
				var longitude = pos.coords.longitude;


				/*  AJAX 통신을 사용해서 저장 */
				console.log(latitude);
				console.log(longitude);


				var mapOptions = {
					zoom: 14,
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					center: new google.maps.LatLng(latitude,longitude)
				};

				map = new google.maps.Map(document.getElementById('map'),mapOptions);

				// 현재 위치 마커 생성
				var marker = new google.maps.Marker({
					position: new google.maps.LatLng(latitude,longitude),
					map: map,
					draggable: false,
					icon: "http://maps.google.com/mapfiles/ms/micons/man.png"
				});
				markers.push(marker);

				// 현재 위치 기준 원 그리기
				var populationOptions = {
					strokeColor: '#000000',
					strokeOpacity: 0.8,
					strokeWeight: 2,
					fillColor: '#808080',
					fillOpacity: 0.5,
					map: map,
					center: new google.maps.LatLng(latitude,longitude) ,
					radius: 1000
				};
				cityCircle = new google.maps.Circle(populationOptions);

				/*
				var _data = {"type":"FeatureCollection",
							"features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[37.515836,127.020132]},"id":"usc000csx3"},
							{"type":"Feature","geometry":{"type":"Point","coordinates":[37.517932,127.021830]},"id":"ak10559055"},
							{"type":"Feature","geometry":{"type":"Point","coordinates":[37.515366,127.024900]},"id":"ak10559055"},
							{"type":"Feature","geometry":{"type":"Point","coordinates":[37.5107224,127.033926]},"id":"ak10559055"},
							{"type":"Feature","geometry":{"type":"Point","coordinates":[37.515688,127.021456]},"id":"ak10559055"}]};
				*/

				for (var i = 0; i < google_data.features.length; i++) {
							var coords = google_data.features[i].geometry.coordinates;
							var latLng = new google.maps.LatLng(coords[0],coords[1]);
							var marker = new google.maps.Marker({
								position: latLng,
								map: map
							});
						}

			}, function (error) {
				switch (error.code) {
				case 1:
					$("#errormsg").html("User denied the request for Geolocation.");
					break;
				case 2:
					$("#errormsg").html("Location information is unavailable.");
					break;
				case 3:
					$("#errormsg").html("The request to get user location timed out.");
					break;
				case 0:
					$("#errormsg").html("An unknown error occurred.");
					break;
				}
			});
		} else {
			alert("Geolocation is not supported by this browser.");
		}
	}

	$( window ).load(function() {
		myMap();
	});
    </script>


  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-Mans0k30To1GtjB2-T8DWhd3bmD-nes&callback=myMap">
  </script>

	<button id="myBtn" style="display: none">Open Modal</button>
	<div id="myModal" class="modal">


	  <!-- Modal content -->
	  <div class="modal-content">
		<span class="close">×</span>
		  <div class ="form-group">
					{% csrf_token %}
						<label>photos</label>
						<div id="member_detail_photo"></div>
					</p>
					<p>
						<label>hash tags</label>
						<input type="text" id="member_detail_hashtag" class="form-control" disabled >
					</p>
					<p>
						<button class="btn btn-warning" id="member_like_btn"> 좋아해 </button>
						<button class="btn btn-warning" id="member_chat_btn"> 1:1 채팅 </button>
					</p>
		  </div>
	  </div>
	</div>

{% endblock %}



