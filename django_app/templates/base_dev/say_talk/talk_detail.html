{% extends 'base_dev/base.html' %}
{% block content %}
{% load staticfiles %}
<script src="{% static 'base_dev/js/talk_detail.js' %}"></script>
<link rel="stylesheet" href="{% static 'base_dev/css/opening/register.css' %}">

<script>
var $post_id = '';
$(document).ready(function(){
  $('#loading').hide();
  $('.hidden_class').hide();

  /*
   * 포스트 정보 목록 조회
   */

  var _post_array = {{ talk_detail|safe }};
  var _comment_array = {{ talk_sub_detail|safe }};

   $("#saytalk_detail_templ").tmpl(_post_array).appendTo( "#post_detail_div" );
   $post_id = _post_array[0].id;


   if(_comment_array.length>0){
     $("#saytalk_comment_templ").tmpl(_comment_array).appendTo( "#post_detail_div" );
   }

    _post_array = _post_array.concat(_comment_array);
   $(_post_array).each(function(index, item){
     if(item.talk_img){
       $(item.talk_img.split(',')).each(function(index_sub, item_sub){
           $('#img_'+item.id).append($('<img/>').width('200px').attr('src', '{{ img_url }}'+ item_sub.replace(' ','')));
       });
     }
   });


  /*
   * 이미지 입력
   */

    $('.gridly').gridly({
       base: 60,
       gutter: 10,
       columns: 12
    });

    $("#id_img_file").change(function(){
     var _this = $(this);
     _this.attr('disabled',true);
     var img_length = $('#img_upload_div').find('div').length;
     if(img_length==5){
       alert('이미지는 5개까지 입력 가능합니다.');
       return false;
     }

     var form_data = new FormData();
         form_data.append("img_file",$('input[name=img_file]')[0].files[0])
         formAjax_loading('POST', form_data, "{% url 'collection:temp_image' %}"
             , 'application/json',$('#loading'),$('.img-btn')
             , function(response){
               $('#loading').hide();
               $('.img-btn').show();

               _this.removeAttr('disabled');

                 var img_div = $('#img_upload_div').append(
                      $('<div/>').addClass('brick small').attr('id',response.id)
                                 .append($('<a/>').addClass('delete').text('x'))
                      );
                 $('#id_img_file').val('');


                 var img_div = document.querySelectorAll('.brick')[img_length];
                 img_div.style['background-image'] = 'url('+response.img_file.replace('/img/','/small/')+')';
                 img_div.style['left'] = 160 * img_length;
                 img_length++;

                 event.preventDefault();
                 event.stopPropagation();
                 $('.gridly').append(img_div);
                 return $('.gridly').gridly();
         });
       });

       $('.img-btn').click(function(){
         $('#id_img_file').trigger('click');
       });

       $(document).on("click", ".gridly .delete", function(event) {
             var $this;
             event.preventDefault();
             event.stopPropagation();
             $this = $(this);
             $this.closest('.brick').remove();
             return $('.gridly').gridly('layout');
       });


  /*
   * 뎃글 입력
   */

   $('.write-btn').click(function(){
    $('#image_file_ids').val('')

     $($('#img_upload_div').find('div')).each(function(index, item){
         var image_id = $(item).attr('id');
         var text = $('#image_file_ids').val();
         if(text.length>0){
           text+=','
         }
         text+=image_id;
         $('#image_file_ids').val(text);
     })

     var form_data = new FormData();
     form_data.append("is_parent",$post_id);
     form_data.append("title",$('input[name=title]').val());
     form_data.append("content",$('textarea[name=content]').val());

     if($('#image_file_ids').val().length != 0){
       form_data.append("image_file_ids",$('#image_file_ids').val());
     }

     if($('#hash_tag_ids').val().length != 0){
       form_data.append("hash_tag_ids",$('#hash_tag_ids').val());
     }

     formAjax('POST', form_data, "{% url 'saytalk:posting' %}"
         , 'application/json'
         , function(response){
                 //socket.emit('request new post', response );
                 location.reload();
     });
   });


});
</script>




<main>
  <div class="talk-list-wrapper">
    <div class="talk-headline col-8">
      <h2 class="col-4">Details</h2>
      <div class="talk-btns col-4">
        <button id="comment_btn">댓글달기</button>
      </div>
    </div>

    <section class="talk-detail-container" id="post_detail_div">

      <!-- 댓글달기 클릭 시 뜨는 모달창 -->
      <button id="myBtn" style="display: none">Open Modal</button>

      <div id="mycomment" class="modal col-4" style="display: none">
        <div class="modal-content">
          <span class="modal-close">×</span>
          <div class ="form-group" action="" method="POST">
              <!-- {% csrf_token %}
              {{ post_form.as_p }} -->
            <fieldset>
              <legend class="hidden">댓글 작성하기 폼</legend>
              <label for="comment_text">Content</label>
              <textarea type="text" class="col-8" id="comment_text" name="content"></textarea>
              <input type="hidden" id="image_file_ids" name="image_file_ids">
              <input type="hidden" id="hash_tag_ids" name="hash_tag_ids">

              <div id="img_upload_div" class="gridly"></div>

              <div role="form-inline" class="form-inline" method="POST"  enctype="multipart/form-data" action="">
                <form class="form-group img_upload hidden_class">
                <label for="id_img_file"></label>
                <input class="hidden_class" id="id_img_file" name="img_file" type="file">
                <span id="file_temp_submit" class="btn btn-danger"></span>
                </form>
                <span class="img-btn btn btn-danger">첨부파일 추가</span>
                <img id="loading" src="{% static 'base_dev/images/register/big-roller2.gif' %}" alt="">
              </div>

              <button type="submit" class="write-btn">enter</button>
            </fieldset>
          </div>
        </div>
      </div>




    </section>
  </div>
</main>



<!-- 말풍선 안에 표시될 실제 *** 메인 컨텐츠 *** 데이터 가져오기 -->
<script id="saytalk_detail_templ" type="text/x-jquery-tmpl">
  <div class="talk-main-content col-6">
    <div class="talk-paragraph col-5">
      <h3>${title}</h3>
      <p>${content}</p>
      <div class="edit-footer">
        <div class="if-my-content">
          <img src="{% static 'base_dev/images/edit_item.png' %}" title="수정" alt="수정하기">
          <img src="{% static 'base_dev/images/delete_item.png' %}" title="삭제" alt="삭제하기">
        </div>
        <span>${username}</span>
      </div>
    </div>
    <div class="talk-img col-3" id="img_${id}"></div>
  </div>
</script>



<!-- 말풍선 안에 표시될 실제 *** 댓글 컨텐츠 *** 데이터 가져오기 -->
<script id="saytalk_comment_templ" type="text/x-jquery-tmpl">
  <div class="talk-comment col-5">
    <div class="talk-paragraph col-5">
      <p>${content}</p>
      <div class="edit-footer">
        <div class="if-my-content">
          <img src="{% static 'base_dev/images/edit_item.png' %}" title="수정" alt="수정하기">
          <img src="{% static 'base_dev/images/delete_item.png' %}" title="삭제" alt="삭제하기">
        </div>
        <span>${username}</span>
      </div>
    </div>
    <div class="talk-img col-3" id="img_${id}"></div>
  </div>
</script>




<footer class="talk-footer">
	<div class="footer col-8">
		<div class="footer-row col-3">
			<a href="#">Privacy &amp; Cookies</a>
			<a href="#">Terms &amp; Conditions</a>
			<a href="#">Accessibility</a>
			<a href="#">FAQ</a>
		</div>
		<div class="copyright col-4">
			<p>The celebrities named of featured on asos.com have not
				endorsed recommended or approved the items offered
				on site.
			</p>
			<p>Copyright © 2016 - All Rights Reserved</p>
		</div>
	</div>
</footer>

{% endblock content %}
