{% extends 'base_dev/base.html' %}
{% block content %}
{% load staticfiles %}

<script src="{% static 'base_dev/js/opening/jquery.gridly.js' %}"></script>
<script src="{% static 'base_dev/js/opening/materialize-tags.js' %}"></script>
<link rel="stylesheet" href="{% static 'base_dev/css/opening/jquery.gridly.css' %}">
<link rel="stylesheet" href="{% static 'base_dev/css/opening/register.css' %}">
<link rel="stylesheet" href="{% static 'base_dev/css/opening/materialize-tags.css' %}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script>
	$(document).ready(function(){
		$('#loading').hide();
		$('.hidden_class').hide();

		/*
		 * 닉네임 중복여부 확인
		 */

		$('#join-name').keyup(function(e){
				$('.hidden_class').hide();
				$('input[name=password_1]').val('');
				$('input[name=password_2]').val('');

				if (e.keyCode == 13 || e.keyCode == 9){
					$('#nickname_div').empty();
				  if(String($('#join-name').val()).length==0){
					   $("#alert_related_text").tmpl({'text':'이름을 입력하십시오'}).appendTo( "#nickname_div" );
					   return false;
				   }

					postAjax('POST', {'nickname' : $('#join-name').val()}, "{% url 'member:nickname_duplicate' %}"
						, 'application/x-www-form-urlencoded', function(response){
								if(!response.response){
								$('.password-join-form').show();
								}else{
								$("#alert_related_text").tmpl({'text':'중복된 사용자 이름입니다.'}).appendTo( "#nickname_div" );
								}
					});
				};

		});

		/*
		 * 비밀 번호 일치여부 확인
		 */

		$('input[name=password_1]').keyup(function(){
		  $('#password_div').empty();
			var password = $(this).val();

			if (password.length < 8){
			   $("#alert_related_text").tmpl({'text':'암호 길이가 짧습니다.'}).appendTo( "#password_div" );
				 $('.img_hash_join_class').hide();
				return false;
			}

			var hasUpperCase = /[A-Z]/.test(password);
			var hasLowerCase = /[a-z]/.test(password);
			var hasNumbers = /\d/.test(password);
			var hasNonalphas = /\W/.test(password);
			if (hasUpperCase + hasLowerCase + hasNumbers + hasNonalphas < 3 ){
			   $("#alert_related_text").tmpl({'text':'암호에 대문자, 숫자를 섞어서 사용해주십시오'}).appendTo( "#password_div" );
				 $('.img_hash_join_class').hide();
			   return false;
			}else if($('input[name=password_1]').val()!=$('input[name=password_2]').val()){
				 $("#alert_related_text").tmpl({'text':'암호가 불일치합니다.'}).appendTo( "#password_div" );
				 $('.img_hash_join_class').hide();
				 return false;
			}


		});

		$('input[name=password_2]').keyup(function(){
			$('#password_div').empty();
			if($('input[name=password_1]').val()!=$('input[name=password_2]').val()){
			   $("#alert_related_text").tmpl({'text':'암호가 불일치합니다.'}).appendTo( "#password_div" );
				 $('.img_hash_join_class').hide();
			}else{
				 $('.img_hash_join_class').show();
			}
		});


		/*
		 * 이미지 파일 첨부
		 */

		$("#id_img_file").change(function(){
			var _this = $(this);
			_this.attr('disabled',true);
			var img_length = $('#img_upload_div').find('div').length;
			if(img_length==5){
				alert('이미지는 5개까지 입력 가능합니다.');
				return false;
			}

			var form_data = new FormData();
					form_data.append("img_file",$('input[name=img_file]')[0].files[0])
					formAjax_loading('POST', form_data, "{% url 'collection:temp_image' %}"
							, 'application/json',$('#loading'),$('.img-btn')
							, function(response){
								$('#loading').hide();
								$('.img-btn').show();

								_this.removeAttr('disabled');

									var img_div = $('#img_upload_div').append(
									     $('<div/>').addClass('brick small').attr('id',response.id)
									      	        .append($('<a/>').addClass('delete').text('x'))
									   	 );
									$('#id_img_file').val('');


									var img_div = document.querySelectorAll('.brick')[img_length];
									img_div.style['background-image'] = 'url('+response.img_file.replace('/img/','/small/')+')';
									img_div.style['left'] = 160 * img_length;
									img_length++;

									event.preventDefault();
  								event.stopPropagation();
  								$('.gridly').append(img_div);
  								return $('.gridly').gridly();
					});
		});

		$('.gridly').gridly({
				base: 60,
				gutter: 10,
				columns: 12
		});

		$('.img-btn').click(function(){
			$('#id_img_file').trigger('click');
		});

		$(document).on("click", ".gridly .delete", function(event) {
      		var $this;
      		event.preventDefault();
      		event.stopPropagation();
      		$this = $(this);
      		$this.closest('.brick').remove();
      		return $('.gridly').gridly('layout');
  	});


		/*
		 * 해시 태그 등록
		 */

		$('.n-tag').keyup(function(e) {
		    if (e.keyCode == 13 || e.keyCode == 9){
						$(this).val('');
				};
		});


		/*
		 * 회원 등록
		 */

		$('.join-btn').click(function(){
				var form_data = $("#register_form").serialize();

				$('#image_file_ids').val('');
				$($('#img_upload_div').find('div')).each(function(index, item){
						var image_id = $(item).attr('id');
						var text = $('#image_file_ids').val();
						if(text.length>0){
							text+=','
						}
						text+=image_id;
						$('#image_file_ids').val(text);
				})

			 $('#hash_tag_names').val('');
			 $($('.materialize-tags').find('span')).each(function(index, item){
				   var tag_name = String($(item).text()).replace('close','');
					 var text = $('#hash_tag_names').val();
					 if(text.length>0){ text+=',' }
					 text+= tag_name;
					 $('#hash_tag_names').val(text);
			 });


			var form_data = new FormData();
			form_data.append("username",$('input[name=username]').val());
			form_data.append("password_1",$('input[name=password_1]').val());
			form_data.append("password_2",$('input[name=password_2]').val());

			if($('#image_file_ids').val().length != 0){
				form_data.append("image_file_ids",$('#image_file_ids').val());
		  }

			if($('#hash_tag_names').val().length != 0){
				form_data.append("hash_tag_names",$('#hash_tag_names').val());
			}

			formAjax('POST', form_data, "{% url 'member:register' %}"
					, 'application/json'
					, function(response){
							if(response.response){
									location.href="{% url 'member:around_me' %}";
							}else{

									alert('error baby');

							}

			});

		});
	});


</script>

<script id="alert_related_text" type="text/x-jquery-tmpl">
		<div class="col-5" style="margin: auto; color: red;">
			${ text }
		</div>
</script>




<main>
	<div class="container">
		<div class="visual2 col-4"></div>
		<div class="content-box col-4">

			<h2>Join Us!</h2>

	 		<div id="register_form" role="form" class="form-group" method="POST" action="{% url 'member:register' %}">
				<!-- {{ register_form.as_p }} -->
			  <form action="" autocomplete="off">
				<fieldset>
					<legend class="hidden">회원가입 폼</legend>
					<div class="n-form ">
						<label for="join-name" class="form-label">Name</label>
						<input type="text" id="join-name" name="username" class="form-input" required placeholder="닉네임을 입력해주세요">
					</div>
					<div id="nickname_div"></div>
					<div class="pw-form hidden_class password-join-form">
						<label for="join-ps" class="form-label">Password</label>
						<input type="password" id="join-ps" name="password_1" class="form-input" required placeholder="비밀번호를 입력해주세요">
					</div>
					<div class="ps-cf-form hidden_class password-join-form">
						<label for="join-ps-cf" class="form-label">Password 확인</label>
						<input type="password" id="join-ps-cf" name="password_2" class="form-input" required placeholder="비밀번호를 재입력해주세요">
					</div>
					<div id="password_div"></div>

					<div id="img_upload_div" class="col-5 gridly img_hash_join_class hidden_class"></div>
					<div id="img_upload_form" class="img_hash_join_class hidden_class" method="POST">
							<a class="img-btn"><span> 이미지 첨부 </span></a>
							<img id="loading" src="{% static 'base_dev/images/register/big-roller2.gif' %}" alt="">
							<div class="form-group img-submit hidden_class">
								 <input class="form-control" id="id_img_file" name="img_file" type="file" required />
							</div>
					</div>

					<div class="img_hash_join_class hidden_class" id="hash_tag_forms" style="margin-top: 10px;" >
						<input id="hash_tag_inputs" type="text" required placeholder="해시태그 추가" data-role="materialtags">
						<div id="hash_tag_div" class="gridly_hashTag"></div>
					</div>
				</fieldset>
				</form>
				<p><input type="hidden" id= "image_file_ids" name="image_file_ids" class="form-control"></p>
				<p><input type="hidden" id= "hash_tag_names" name="hash_tag_names" class="form-control"></p>
			  <div role="form-inline" class="form-inline hidden_class" method="POST"  enctype="multipart/form-data" action="">
				  <div class="form-group img-submit">
				  <!-- {{ register_image_form }} -->
						<tr><td><input class="form-control" id="id_img_file" name="img_file" type="file" required /></td></tr>
				  	<a href="#"><span id="file_temp_submit" class="img-submit-btn">사진 추가</span></a>
				  </div>
			  </div>

				<div class="register-btn hidden_class img_hash_join_class">
					<button type="submit" class="join-btn">회원가입</button>
				</div>
			</div>
		</div>
	</div>
</main>
<footer>
	<div class="footer col-8">
		<div class="footer-row col-3">
			<a href="#">Privacy &amp; Cookies</a>
			<a href="#">Terms &amp; Conditions</a>
			<a href="#">Accessibility</a>
			<a href="#">FAQ</a>
		</div>
		<div class="copyright col-4">
			<p>The celebrities named of featured on asos.com have not
				endorsed recommended or approved the items offered
				on site.
			</p>
			<p>Copyright © 2016 - All Rights Reserved</p>
		</div>
	</div>
</footer>


{% endblock %}
